<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paste & Upload Screenshots</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    #dropzone {
      border: 2px dashed #888;
      border-radius: 8px;
      padding: 1.2em;
      text-align: center;
      color: #888;
      background: #fafafa;
      margin-bottom: 1em;
    }
    .custom-section-title {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.125rem;
      color: #2e4a7b;
      font-weight: 700;
      margin-bottom: 0.5em;
      margin-top: 0.5em;
    }
    .img-row {
      margin-bottom: 0.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .img-preview {
      max-width: 90px;
      max-height: 45px;
      display: block;
      margin-bottom: 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }
    .img-link { font-size: 0.9em; word-break: break-all; }
    .img-name {
      width: 110px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    .delete-btn {
      background: #f8d7da;
      color: #721c24;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
      margin-left: 2px;
    }
    .delete-btn:hover {
      background: #f5c6cb;
    }
    .rename-warning {
      color: #d9534f;
      font-size: 0.95em;
      margin-bottom: 0.5em;
      font-weight: 600;
    }
    .img-status {
      font-size: 1.2em;
      margin-left: 4px;
    }
    #stickyUploadBar {
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      padding: 10px 0 0 0;
      z-index: 100;
      display: flex;
      justify-content: flex-start;
    }
    #batchUploadBtn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 16px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    #batchUploadBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #blocker {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      color: #d9534f;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="custom-section-title">Paste or Drag Screenshots</div>
  <div id="dropzone" tabindex="0">
    <div id="instructions">
      <p>
        Press  &nbsp;<strong><i class="fa fa-windows" style="font-size:24px"></i> + shift + S</strong> and take screenshot, click here and press <b>Ctrl+V</b> to paste.<br>
        Rename each image matching the test step. for example, 1_accessible, 1_tracert.<br>
        Make sure to include the time display of your laptop.<br>
        Images will be uploaded when you submit the form.
      </p>
    </div>
  </div>
  <div id="renameWarning" class="rename-warning" style="display:none;">Please rename all images before submitting!</div>
  <div id="images"></div>
  <div id="stickyUploadBar">
    <button id="batchUploadBtn" style="display:none;">Upload All Images</button>
  </div>
  <div id="blocker">Please upload all images before submitting the form.</div>
  <script>
    function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name) || '';
}

const fullName = getQueryParam('fullName');
const org = getQueryParam('org');
const testName = getQueryParam('testName');
const uniqueID = getQueryParam('uniqueID');

console.log('Full Name:', fullName);
console.log('Organization:', org);
console.log('Test Name:', testName);
console.log('unique IDID:', uniqueID);
  // --- Hardcoded folder name for all uploads ---
const FORM_FOLDER_NAME = "(Before DR Swing) Sabah Gov DR Drill 2025 Checklist";

// --- Identify page via URL param (for per-page storage) ---
const PAGE_ID = getQueryParam('pageId') || 'defaultPage';

// --- Helper to get a unique prefix for this submission ---
const submissionPrefix = 'submission_' + Date.now();

// --- Helper to get URL params (not used for naming anymore, but kept for future use) ---
function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name) || '';
}

// Get Jotform data from URL (not used for naming anymore)
let driveField = getQueryParam('driveField') || '';

// alert('formName: ' + (getQueryParam('formName') || 'DefaultForm') + '\nsubmissionId: ' + (getQueryParam('submissionId') || 'NoID') + '\nuserName: ' + (getQueryParam('userName') || 'NoName') + '\norganization: ' + (getQueryParam('organization') || 'NoOrg') + '\ndriveField: ' + driveField);

const dropzone = document.getElementById('dropzone');
const imagesDiv = document.getElementById('images');
const renameWarning = document.getElementById('renameWarning');
let images = [];

// Your Cloud Function URL (should not change)
const CLOUD_FUNCTION_URL = 'https://asia-southeast1-jotform-paste-upload.cloudfunctions.net/uploadImage';
// Your Google Drive root folder ID (parent folder for all forms)
const DRIVE_ROOT_FOLDER_ID = '1VFvqcSDShsIdKbY1yAkEdbxgLH6ppYyl';

// --- Persistence helpers ---
function getStorageKey() {
  return 'jotform_images_' + FORM_FOLDER_NAME + '_' + PAGE_ID;
}
function saveImagesToStorage() {
  sessionStorage.setItem(getStorageKey(), JSON.stringify(images));
}
function loadImagesFromStorage() {
  const stored = sessionStorage.getItem(getStorageKey());
  if (stored) {
    try {
      const arr = JSON.parse(stored);
      if (Array.isArray(arr) && arr.every(img => img.dataUrl && img.name)) {
        images = arr;
        renderImages();
      }
    } catch (e) {
      images = [];
    }
  }
}
function clearImagesFromStorage() {
  sessionStorage.removeItem(getStorageKey());
}

function addImage(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const imgObj = {
      file: null,
      dataUrl: e.target.result,
      name: file.name.replace(/\.[^/.]+$/, "") // name without extension
    };
    images.push(imgObj);
    renderImages();
    saveImagesToStorage();
  };
  reader.readAsDataURL(file);
}

function renderImages() {
  const instructionsDiv = document.getElementById('instructions');
  if (images.length === 0) {
    instructionsDiv.innerHTML = `
      <p>
        Press <i style="font-size:24px" class="fa fa-windows"></i> + shift + S and take screenshot, click here and press <b>Ctrl+V</b> to paste.<br>
        Rename each image matching the test step. for example, 1_accessible, 1_tracert.<br>
        Make sure to include the time display of your laptop.<br>
        Images will be uploaded when you submit the form.
      </p>
    `;
  } else {
    instructionsDiv.innerHTML = `
      <p><b>Make sure to rename each image matching the test step.</b></p>
    `;
  }

  imagesDiv.innerHTML = '';
  images.forEach((img, idx) => {
    const row = document.createElement('div');
    row.className = 'img-row';
    row.innerHTML = `
      <img src="${img.dataUrl}" class="img-preview">
      <input class="img-name" type="text" value="${img.name}" placeholder="Image name">
      <button class="delete-btn" title="Delete this image">üóëÔ∏è</button>
      <span class="img-status" id="status${idx}">
        ${img.status === 'uploading' ? '‚è≥' : img.status === 'success' ? '‚úîÔ∏è' : img.status === 'error' ? '‚ùå' : ''}
      </span>
      <span class="img-link" id="link${idx}">${img.link ? `<a href="${img.link}" target="_blank">View</a>` : ''}</span>
    `;
    row.querySelector('.img-name').addEventListener('input', e => {
      img.name = e.target.value;
      saveImagesToStorage();
    });
    row.querySelector('.delete-btn').addEventListener('click', () => {
      images.splice(idx, 1);
      renderImages();
      saveImagesToStorage();
    });
    imagesDiv.appendChild(row);
  });

  // Show the upload button if there are images
  const batchUploadBtn = document.getElementById('batchUploadBtn');
  if (images.length > 0) {
    batchUploadBtn.style.display = '';
  } else {
    batchUploadBtn.style.display = 'none';
  }
}

dropzone.addEventListener('paste', function(e) {
  const items = (e.clipboardData || e.originalEvent.clipboardData).items;
  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf('image') !== -1) {
      const file = items[i].getAsFile();
      addImage(file);
    }
  }
});

dropzone.addEventListener('dragover', function(e) {
  e.preventDefault();
  dropzone.style.background = '#e0e0e0';
});
dropzone.addEventListener('dragleave', function(e) {
  dropzone.style.background = '#fafafa';
});
dropzone.addEventListener('drop', function(e) {
  e.preventDefault();
  dropzone.style.background = '#fafafa';
  for (const file of e.dataTransfer.files) {
    if (file && file.type.startsWith('image/')) {
      addImage(file);
    }
  }
});

dropzone.addEventListener('click', function() {
  dropzone.focus();
});

function validateImageNames() {
  for (let img of images) {
    if (img.name.trim().toLowerCase() === 'image' || img.name.trim() === '') {
      return false;
    }
  }
  return true;
}

function isDefaultName(name) {
  // Checks for default/placeholder names. Update this logic for Jotform integration later.
  return (
    name.trim().toLowerCase() === 'image' ||
    name.trim() === '' ||
    name.startsWith('defaultPage_') ||
    name.startsWith(PAGE_ID + '_')
  );
}

// Widget API: Listen for Jotform next/submit
window.addEventListener('message', function(e) {
  if (e.data && (e.data.type === 'next' || e.data.type === 'submit')) {
    if (images.some(img => isDefaultName(img.name))) {
      renameWarning.style.display = 'block';
      window.parent.postMessage({ action: 'cancelSubmission', reason: 'Please rename all images.' }, '*');
      return;
    }
    renameWarning.style.display = 'none';
    Promise.all(images.map((img, idx) => uploadToDrive(img, idx)))
      .then(links => {
        // Show links in the widget
        imagesDiv.innerHTML += '<div><b>Uploaded to Google Drive:</b><br>' + links.map(link => `<a href="${link}" target="_blank">${link}</a>`).join('<br>') + '</div>';
        // Optionally, trigger Jotform submit
        window.parent.postMessage({ action: 'submit' }, '*');
        clearImagesFromStorage();
      })
      .catch(() => {
        window.parent.postMessage({ action: 'cancelSubmission', reason: 'Upload failed.' }, '*');
      });
  }
});

// Upload to Drive, using hardcoded prefix for now
async function uploadToDrive(img, idx) {
  // 1. Create/get subfolder for this form (hardcoded)
  const formFolderId = await getOrCreateSubfolder(FORM_FOLDER_NAME, DRIVE_ROOT_FOLDER_ID);
  // 2. Hardcoded image name prefix. TODO: Make this dynamic for Jotform integration.
  const fileName = `PREFIX_${img.name}.png`; // <-- Change 'PREFIX_' as needed
  // --- Debug: log before fetch ---
  console.log('Uploading image:', fileName, 'to folder:', formFolderId);
  return fetch(CLOUD_FUNCTION_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      imageBase64: img.dataUrl.split(',')[1],
      fileName: fileName,
      folderId: formFolderId
    })
  })
  .then(res => res.json())
  .then(data => {
    // --- Debug: log after fetch ---
    console.log('Upload response:', data);
    return data.webViewLink || 'Upload failed';
  });
}

// Helper: Create or get subfolder for form
async function getOrCreateSubfolder(folderName, parentId) {
  const cacheKey = 'subfolder_' + parentId + '_' + folderName;
  let cached = localStorage.getItem(cacheKey);
  if (cached) return cached;

  const res = await fetch(CLOUD_FUNCTION_URL + '/createSubfolder', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ formName: folderName, parentId })
  });
  const data = await res.json();
  if (data.folderId) {
    localStorage.setItem(cacheKey, data.folderId);
    return data.folderId;
  }
  return parentId;
}

// --- Load images from storage on page load ---
loadImagesFromStorage();

batchUploadBtn.addEventListener('click', async function() {
  // Check for default names
  let hasDefault = images.some(img => isDefaultName(img.name));
  if (hasDefault) {
    alert('Please rename all images before uploading!');
    return;
  }
  for (let idx = 0; idx < images.length; idx++) {
    let img = images[idx];
    if (img.status !== 'success') {
      img.status = 'uploading';
      renderImages();
      saveImagesToStorage();
      try {
        const link = await uploadToDrive(img, idx);
        img.status = 'success';
        img.link = link;
      } catch {
        img.status = 'error';
      }
      renderImages();
      saveImagesToStorage();
    }
  }
}); 
  </script>
</body>
</html>